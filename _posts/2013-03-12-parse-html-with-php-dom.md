---
title: Parse HTML with PHP DOM
author: James Tang
layout: post
permalink: /code/parse-html-with-php-dom/
categories:
  - Code
tags:
  - DOM
  - HTML
  - PHP
---
With PHP DOM extension, parsing HTML data is straightforward just as parsing DOM in JavaScript. This post will demonstrate how to use DOMDocument and DOMXPath to extract data in which we are interested from general HTML file, but not strictly structured as XML.

Sample file looks like this:

<pre class="brush:html;collapse: true">&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;王小五 - Profile&lt;/title&gt;
        &lt;meta charset="utf-8" /&gt;
        &lt;link href="/css/profile.css" rel="stylesheet" type="text/css"/&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;div id="wrapper"&gt;
            &lt;div id="header"&gt;
                &lt;h1&gt;王小五&lt;/h1&gt;
            &lt;/div&gt;
            &lt;div id="content"&gt;
                &lt;div id="profile-box"&gt;
                    &lt;div id="profile-img"&gt;
                        &lt;img id="profile-img" src="/profile_img.php?uid=32153" alt="" /&gt;
                    &lt;/div&gt;
                    &lt;ul class="ulist"&gt;
                        &lt;li&gt;
                            &lt;span class="field-name"&gt;Age:&lt;/span&gt; 
                            &lt;span class="field-value"&gt;31&lt;/span&gt;
                        &lt;/li&gt;
                        &lt;li&gt;
                            &lt;span class="field-name"&gt;Gender:&lt;/span&gt; 
                            &lt;span class="field-value"&gt;Female&lt;/span&gt;
                        &lt;/li&gt;
                        &lt;li&gt;
                            &lt;span class="field-name"&gt;Location:&lt;/span&gt; 
                            &lt;span class="field-value"&gt;Guangzhou, China&lt;/span&gt;
                        &lt;/li&gt;
                    &lt;/ul&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            &lt;div id="footer"&gt;
                &lt;div class="x13"&gt;&copy; 2012 cctv.&lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/body&gt;
&lt;/html&gt;
</pre>

## 1. Load HTML

The simplest code looks like this:

<pre class="brush:php">$html = file_get_contents('data.html');
$dom = new DOMDocument();
$dom->loadHTML($html);
$xpath = new DOMXPath($dom);
</pre>

Notice that there are two elements with id=&#8221;profile-img&#8221; in the HTML, it&#8217;s not a &#8220;valid&#8221; HTML page, so when you try to run the code, you will encounter following PHP warning:

<pre class="brush:plain">PHP Warning:  DOMDocument::loadHTML(): ID profile-img already defined in Entity, line: 16 in /home/james/projects/mixedlab/linux/php/xml/dom/demo/demo.php on line 6
</pre>

Most of the times we&#8217;d like to ignore such warnings for it&#8217;s no likely for us to change the source html file which may generated by other PHP script written by a negligent programmer. Fortunately, this problem can be solved with just a little additional work: 

<pre class="brush:php">libxml_use_internal_errors(true);

$html = file_get_contents('data.html');
$dom = new DOMDocument();
$dom->loadHTML($html);
$xpath = new DOMXPath($dom);

libxml_clear_errors();
</pre>

Set libxml\_use\_internal_errors to true to suppress the warning, but still you can catch the errors if you want to do something beside just ignore it.

Another problem we should solve is the file encoding. The demo HTML data was encoded in UTF-8, as the meta header shows, but DOMDocument cannot recognize it. DOMDocument can only accept http-equiv meta, so we have to do some preprocess on the HTML:

<pre class="brush:php">$html = str_replace(
    '

<meta charset="utf-8" />
', 
    '

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
', 
    $html
);
</pre>

## 2. Extract Data

Although DOMDocument provides many methods for manipulating elements, such as DOMDocument::getElementsByClassName(), but I think it&#8217;s less useful and more complicated than using XPath.

XPath::query(string $expression [, DOMNode $contextnode [, bool $registerNodeNS = true ]]) always return a DOMNodeList object if the $expression is well formed and $contextnode is valid or NULL(not set).

Extract user name from header(h1):

<pre class="brush:php">$nodes = $xpath->query('//*[@id="header"]/h1');
$name = $nodes->item(0)->nodeValue;
echo "Name: " . $name . "\n";
</pre>

In most cases, the HTML structure is more complicated than the demo, and $contextnode will help us focus on the restricted section and keep the xpath query concise.

Extract sub-node by specifying the context node(for demonstration only in this case):

<pre class="brush:php">$nodes = $xpath->query('//div[@id="header"]');
$headerNode = $nodes->item(0);
$nodes = $xpath->query('h1', $headerNode);
$name = $nodes->item(0)->nodeValue;
echo "Name: " . $name . "\n";
</pre>

Extract user properties:

<pre class="brush:php">$nodes = $xpath->query('//*[@id="profile-box"]/ul/li');
foreach ($nodes as $node) {
    $childNodes = $xpath->query('span', $node);
    $key = $childNodes->item(0)->nodeValue;
    $value = $childNodes->item(1)->nodeValue;
    echo $key . ' ' . $value . "\n";
}
</pre>

## 3. innerHTML function

Here provides a useful function for extracting the inner HTML for one node:

<pre class="brush:php">function innerHTML($node)
{
    $meta = '

<meta http-equiv="content-type" content="text/html;charset=utf-8" />
';
    $dom = new DOMDocument();
    $dom->loadHTML($meta);
    $dom->appendChild($dom->importNode($node, true));
    $html = preg_replace(
        '#^.*&lt;/html>&lt;' . $node->nodeName . '[^>]*>(.*)&lt;/' . $node->nodeName . '>.*$#s', 
        '\1', $dom->saveHTML());
    return $html;
}
</pre>

## 4. Reference

PHP Dom Manual: <http://php.net/manual/en/book.dom.php>

Full Demo for this Post: <https://github.com/fwso/mixedlab/tree/master/linux/php/xml/dom/demo>