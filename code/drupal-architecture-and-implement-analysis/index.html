<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Drupal架构与实现分析</title>
  <meta name="description" content="      不尽知用兵之害者，则不能尽知用兵之利——孙武《孙子兵法》  ">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://tangobean.com/code/drupal-architecture-and-implement-analysis/">
  <link rel="alternate" type="application/rss+xml" title="TangoBean" href="http://tangobean.com/feed.xml" />
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">TangoBean</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Drupal架构与实现分析</h1>
    <p class="post-meta">Mar 26, 2012 • James Tang</p>
  </header>

  <article class="post-content">
    <blockquote class="post-top-quote">
  <p>
    不尽知用兵之害者，则不能尽知用兵之利——孙武《孙子兵法》
  </p>
</blockquote>

<p>Drupal也算是架构精良的PHP开源CMS，它最大的优点是可以灵活性高，不仅可以用于实现一般的CMS功能，还可以容易的实现其它应用，如Drupal官方所说，可以实现wiki, blog甚至商城等.它最大的问题是灵活性太高，如果没有根据实际情况进行设计与管理，后果会很糟糕。</p>

<p>先看一下Drupal的总体架构，下图是Drupal官方的信息流图，详细参见：http://drupal.org/getting-started/before/overview。</p>

<p><a href="http://tangobean.com/wp-content/uploads/2012/03/drupal_flow_0.gif"><img src="http://tangobean.com/wp-content/uploads/2012/03/drupal_flow_0.gif" alt="" title="Drupal information flow" width="528" height="562" class="alignnone size-full wp-image-380" /></a></p>

<p>从图上看起来非常清晰明了，不过这并没有体现出Drupal的架构方式。在我看来Drupal的基本架构就是Drupal核心+模块+模板，所谓的Drupal核心除模块之外的最基础的代码，全部在includes目录下面，另外Drupal有几个核心模块，如System, User, Node等。</p>

<p>Drupal的处理流程如下：</p>

<ul>
  <li>系统初始化</li>
  <li>路径解析（路由）</li>
  <li>页面内容渲染</li>
  <li>页面布局及block渲染</li>
  <li>生成页面</li>
</ul>

<h2 id="hook">1. Hook</h2>

<p>Drupal几乎是纯面向过程的架构，这或许让很多习惯OOP的人有点惊讶，这或许也是Drupal变得难以管理（源码，模块）的原因。Hook是Drupal架构实现的关键,模块通过种hook与Drupal进行交互，这种方式被称为基于过程的AOP<sup><a href="http://tangobean.com/wp-content/uploads/2012/03/drupal_flow_0.gif">1</a></sup>。</p>

<p>大多数情况下，Drupal通过module_invoke_all()来调用指定的hooks, 如下面代码将调用所有MODULE_NAME_cron()这样的函数:</p>

<pre class="brush:php">module_invoke_all('cron');
</pre>

<p>下面是module_invoke_all()的源码，参数通过func_get_args函数获得，返回值是可选的。顺便提一下，在Drupal及其模块中经常用到func_get_args函数。</p>

<pre class="brush:php">function module_invoke_all() {
  $args = func_get_args();
  $hook = $args[0];
  unset($args[0]);
  $return = array();
  foreach (module_implements($hook) as $module) {
    $function = $module .'_'. $hook;
    $result = call_user_func_array($function, $args);
    if (isset($result) &#038;&#038; is_array($result)) {
      $return = array_merge_recursive($return, $result);
    }   
    else if (isset($result)) {
      $return[] = $result;
    }   
  }

  return $return;
}
</pre>

<p>module_invoke_all()并不是唯一的调用hook的方式，另一个比较常用的是drupal_alter，hook_menu_alter()、hook_mail_alter等就是通过该函数实现的。drupal_alter()与module_invoke_all()的主要差别是drupal_alter()是通过传递参数引用给模块，让模块可以个性数据。</p>

<pre class="brush:php">drupal_alter('menu', $callbacks);
</pre>

<pre class="brush:php">drupal_alter('form', $data, $form_id);
</pre>

<p>drupal_alter()的源码片段:</p>

<pre class="brush:php">function drupal_alter($type, &#038;$data) {
  //省略
  foreach (module_implements($type .'_alter') as $module) {
    $function = $module .'_'. $type .'_alter';
    call_user_func_array($function, $args);
  }
}
</pre>

<p>除了drupal_alter()与module_invoke_all()之外，模块也可以自定义调用hook的逻辑，就像hook_nodeapi的实现一样，如下面的代码所示。但它们都需要调用module_implements()来得知有哪些模块实现了该hook。</p>

<pre class="brush:php">function node_invoke_nodeapi(&#038;$node, $op, $a3 = NULL, $a4 = NULL) {
  $return = array();
  foreach (module_implements('nodeapi') as $name) {
    $function = $name .'_nodeapi';
    $result = $function($node, $op, $a3, $a4);
    if (isset($result) &#038;&#038; is_array($result)) {
      $return = array_merge($return, $result);
    }    
    else if (isset($result)) {
      $return[] = $result;
    }    
  }
  return $return;
}
</pre>

<h2 id="section">2. 模块</h2>

<p>模块主要用于扩展系统功能，一般都会实现一个或多个hook，如hook_menu是最常见的，但这并不是必须的。是简单的模块只需要包含MODULE_NAME.module与MODULE_NAME.info即可，MODULE_NAME.install用于处理模块安装及卸载相关的逻辑。</p>

<p>所有模块信息都保存在system表中，system同时也保存模板信息。system.status为0表示模块未启用，system.weight有时候很重要，比如模块A和B同时实现hook_x(), 但A必须在B之后执行，则可以通过weight来控制。weight值越大越迟加载，因为模块的加载顺序如下：</p>

<pre class="brush:sql">SELECT name, filename, throttle FROM {system} WHERE type = 'module' AND status = 1 ORDER BY weight ASC, filename ASC
</pre>

<p>throttle用于控制模块是否被加载，不过几乎不用它。</p>

<h2 id="form">3. Form</h2>

<p>Drupal定义了一套很详细的API用于定义表单及相关处理逻辑，包括元素默认值、验证、显示结构及顺序等，并提供了默认的显示结构与样式（虽然这很不实用）。</p>

<p>第一个表单对应一个函数，也称为form_id， Drupal通过drupal_get_form($form_id)来获得该表单的定义并渲染HTML。如下面代码所示：</p>

<pre class="brush:php">function user_login(&#038;$form_state) {
  global $user;

  // If we are already logged on, go to the user page instead.
  if ($user-&gt;uid) {
    drupal_goto('user/'. $user-&gt;uid);
  }

  // Display login form:
  $form['name'] = array('#type' =&gt; 'textfield',
    '#title' =&gt; t('Username'),
    '#size' =&gt; 60,
    '#maxlength' =&gt; USERNAME_MAX_LENGTH,
    '#required' =&gt; TRUE,
  );

  $form['name']['#description'] = t('Enter your @s username.', array('@s' =&gt; variable_get('site_name', 'Drupal')));
  $form['pass'] = array('#type' =&gt; 'password',
    '#title' =&gt; t('Password'),
    '#description' =&gt; t('Enter the password that accompanies your username.'),
    '#required' =&gt; TRUE,
  );
  $form['#validate'] = user_login_default_validators();
  $form['submit'] = array('#type' =&gt; 'submit', '#value' =&gt; t('Log in'), '#weight' =&gt; 2);

  return $form;
}
</pre>

<p>这是用户登录的表单,form_id就是user_login， 这里有一个参数$form_state，但这并不是定义表单所必须的，通过drupal_get_form(‘user_login’,$form_state)获得该表单并在页面显示。默认情况下表单的action就是当前页面，但可以过来#action来指定其它路径，但#action指向的页面必须调用drupal_get_form($form_id),如drupal_get_form(‘user_login’,$form_state)，否则表单将无法被处理，除非不使用Drupal的方式而是手动来处理表单内容。</p>

<p>第一个表单在渲染之前，Drupal都会自动加上一个form_build_id。</p>

<pre class="brush:html">&lt;input type="hidden" name="form_build_id" id="form-cb48b9e32a4a25f8b1e483153f2c7b06" value="form-cb48b9e32a4a25f8b1e483153f2c7b06" /&gt;
</pre>

<p>form_build_id的主要作用是用于表单缓存，很多时候表单缓存中包含一些跟踪上下文信息，所以如果表单的form_build_id被个性或超时就不能被正确处理。默认情况下，Drupal的缓存是保存在数据库中，表单的缓存则保存在cache_form表中。</p>

<h2 id="menu">4. Menu</h2>

<p>Drupal的Menu非常重要，它用于定义用户可以访问的路径，模块通过实现hook_menu()来新的路径，每个路径对应一个页面。hook_menu()返回一个定义了menu的数组，如下所示：</p>

<pre class="brush:php">$items['node/%node'] = array(
    'title' =&gt; 'View',
    'page callback' =&gt; 'node_page_view',
    'page arguments' =&gt; array(1),
    'access callback' =&gt; 'node_access',
    'access arguments' =&gt; array('view', 1),
    'type' =&gt; MENU_CALLBACK,
  );
</pre>

<p>该数组定义了路径的页面回调函数，访问权限等。</p>

<p>这些信息并不是第次请求都会查找实现了hook_menu的函数，而是缓存在menu_router表中。路径的层次关系等信息刚是缓存在cache_menu表中。</p>

<p>详细文档请参考：http://drupal.org/node/102338</p>

<h2 id="section-1">5. 模板</h2>

<p>类似于hook_menu，hook_theme用于定义模板，模板的定义信息叫做theme registry, 一般都是保存在缓存中，所以每次更新都要更新缓存。</p>

<p>theme()是Drupal模板系统的关键函数，用于渲染HTML。Drupal的模板并非都是模板文件，还可以是函数，一般以theme_开头。</p>

<p>详细文档请参考：http://drupal.org/documentation/theme</p>

<h2 id="section-2">6. 内容与用户</h2>

<p>CMS当然离不开内容与内容管理，Drupal中内容的关键概念是节点，但它并不是在Drupal核心中实现，而是在Node核心模块中实现。所有内容都被看作节点，节点有不同类型，不同类型在总体结构上是一致的。主要的三个数据库关系表分别是node, node_revisions, node_type。另外涉及单个节点权限管理的表是node_access。</p>

<p>用户及用户管理部分主要有三个主要定义：用户(user), 用户组(user roles)及相关权限(permission)。</p>

<h2 id="section-3">7. 系统变量</h2>

<p>Drupal的系统变量以键值对的形式保存在variable表中，也可以在settings.php中配置。variable_get()、variable_set()、variable_del()分别用于获取、设置及删除系统变量。</p>

<h2 id="section-4">8. 缓存</h2>

<p>Drupal的默认缓存保存在数据库中，缓存表在cache_开头。如果需要以其它方式保存缓存数据，如保存到memcache中，只需要实现cache_set(), cache_get(), cache_clear_all()函数，并将cache_inc系统变量设置为自定义缓存处理的PHP文件路径即可。</p>

<h2 id="section-5">9. 总结</h2>

<p>Hook系统让Drupal具有良好的扩展性，同时也容易让调试与维护变得很困难。我认为如果不仅仅是用Drupal做一个像个人博客一样的简单网站，就应该知道：</p>

<ol>
  <li>Drupal虽然能做很多东西，但最好只用来做CMS相关的事，不用的东西彻底砍掉，免得浪费资源。</li>
  <li>仔细分析设计模块与模板，特别是hook的使用一定要慎重，配置要统一且简单，不然调试将变得异常困难。</li>
  <li>不要依赖社区的模块，包括Drupal安装包自带的，大多模块考虑太多的通用性，而不是性能。</li>
  <li>手动打补丁，不要使用自动更新。</li>
  <li>必要时修改Drupal内核。</li>
</ol>

<h2 id="section-6">10. 参考</h2>

<ol>
  <li>Programming language trade-off: http://www.garfieldtech.com/blog/language-tradeoffs</li>
  <li>Architectural priorities: http://www.garfieldtech.com/blog/architectural-priorities</li>
  <li>The Drupal Overview: http://drupal.org/getting-started/before/overview</li>
  <li>Form API Reference: http://api.drupal.org/api/drupal/developer!topics!forms_api_reference.html/6</li>
</ol>


  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">TangoBean</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>TangoBean</li>
          <li><a href="mailto:"></a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/fwso">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">fwso</span>
            </a>
          </li>
          

          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">Think In Practice</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
